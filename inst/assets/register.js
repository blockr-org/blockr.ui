(()=>{"use strict";const e=()=>{let e;$(".add-block").off("mouseenter"),$(".add-block").on("mouseenter",(t=>{const a=$(t.currentTarget);a.closest(".blockr-registry").find(".blockr-description").html(`<small><i class='fas fa-info text-info px-2'></i>${a.data("description")}</small>`),clearTimeout(e),e=setTimeout((()=>{a.closest(".blockr-registry").find(".blockr-description").text("")}),3e3)}))};var t;!function(e){e[e.noStack=1]="noStack",e[e.noBlockIndex=2]="noBlockIndex",e[e.stackAlreadyHasDataBlock=3]="stackAlreadyHasDataBlock",e[e.stackAlreadyHasPlotBlock=4]="stackAlreadyHasPlotBlock",e[e.noStackArea=5]="noStackArea"}(t||(t={}));const a=new Map;a.set(t.noStack,"must drag blocks within a stack"),a.set(t.noStackArea,"cannot place stack here"),a.set(t.noBlockIndex,"could not find block index"),a.set(t.stackAlreadyHasDataBlock,"this stack already includes a data block"),a.set(t.stackAlreadyHasPlotBlock,"this stack already includes a plot block");const s=new Map;var n;s.set(t.noStack,"no-stack"),s.set(t.noBlockIndex,"no-block-index"),s.set(t.stackAlreadyHasDataBlock,"stack-already-has-data-block"),s.set(t.stackAlreadyHasPlotBlock,"stack-already-has-plot-block"),function(e){e[e.deferred=1]="deferred",e[e.throttled=2]="throttled",e[e.immediate=3]="immediate"}(n||(n={}));const o=new Map;o.set(n.deferred,"deferred"),o.set(n.throttled,"throttle"),o.set(n.immediate,"event");const r=e=>{let t=e.id;e.ns&&(t=`${e.ns}-${t}`);const a=o.get(e.priority)||"deferred";Shiny.setInputValue(t,e.message,{priority:a})},l=e=>{const t=e.substring(0,4).normalize();return t[0].toUpperCase()+t.substring(1)+e.substring(4)};let d="",c=0,i="",k=!1;const p=e=>{const t=$(e).closest(".block"),a=t.data("value");let s=0;return t.closest(".stack").find(".block").each(((e,t)=>{$(t).data("value")==a&&(s=e+1)})),s},g=()=>{$(".stack").off("dragover dragenter drop dragdrop"),$(".stack").on("dragover",(e=>{e.preventDefault()})),$(".stack").on("dragenter",(e=>{e.preventDefault()})),$(".stack").on("drop dragdrop",(e=>{k=!0,c<0||(r({id:"dropped",ns:d,message:{type:i,index:c,position:p(e.target),target:$(e.target).closest(".stack").attr("id")},priority:n.immediate}),c=-1)}))},u=e=>{$(`#${e.id} .block-list-wrapper`).each(((t,a)=>{m(a,e)}))},m=(e,o)=>{g(),$(e).find(".add-block").each(((e,p)=>{$(p).hasClass("sorted")||($(p).addClass("sorted"),$(p).on("dragstart",(e=>{var t;i=$(e.target).data("type"),c=$(e.target).data("index"),d=(e=>{const t=null==e?void 0:e.split("-");return null==t?void 0:t.slice(0,t.length-1).join("-")})($(e.target).closest(".blockr-registry").attr("id")),e.originalEvent.dataTransfer.setData("text/plain",null===(t=e.target)||void 0===t?void 0:t.id)})),$(p).on("dragover",(e=>{k=!1,e.preventDefault()})),$(p).on("dragenter",(e=>{r({id:"started",ns:o.ns,message:{type:i,index:c},priority:n.immediate}),e.preventDefault()})),$(p).on("dragend",(()=>{k||(e=>{(e=>{if(!e.feedback)return;const t=$(`#${e.ns}-toast`);t.find(".toast-body").text(l(a.get(e.type))||"Unknown error"),t.show(),setTimeout((()=>{t.hide()}),4500)})(e);const t={ns:e.ns,id:"error",message:{type:s.get(e.type)||"unknown error",message:a.get(e.type)||"unknown error"},priority:n.immediate};r(t),console.error(`${t.message.message}`)})({id:"error",ns:o.ns,type:t.noStack,feedback:o.feedback})})))}))},y=(t,a)=>{const s=a.map((e=>{return`<p class="cursor-pointer mb-1 badge add-block bg-secondary mx-1"\n    data-index = ${(t=e).index}\n    data-name = ${t.name}\n    data-description = ${t.description}\n    draggable = "TRUE">\n    ${t.name}\n  </p>`;var t})).join("");$(`#${t.ns}-scrollable-child`).append(s),u(t),e(),h(t)},b=e=>{$(`#${e.ns}-scrollable`).off("scroll")},f=e=>{b(e),$(`#${e.ns}-scrollable`).on("scroll",(t=>{if($(`#${e.ns}-scrollable-child`).height()-$(`#${e.ns}-scrollable`).height()-$(t.target).scrollTop()>10)return;const a=$(`#${e.ns}-scrollable`).find(".add-block").length;fetch(`${e.scroll}&min=${a}`).then((e=>e.json())).then((t=>{t.length&&y(e,t)}))}))},h=e=>{$(`#${e.ns}-search`).off("click"),$(`#${e.ns}-query`).off("keyup"),$(`#${e.ns}-search`).on("click",v(e)),$(`#${e.ns}-query`).on("keyup",v(e))},v=e=>t=>{if(t.key&&"Enter"!=t.key)return;const{target:a}=t,s=$(`#${e.ns}-query`),n=String(null==s?void 0:s.val());$(a).closest(".blockr-registry").find(".block-list-wrapper").html(""),""!=n?fetch(`${e.search}&query=${encodeURIComponent(n)}`).then((e=>e.json())).then((t=>{y(e,t),b(e)})):fetch(`${e.scroll}&min=1&max=10`).then((e=>e.json())).then((t=>{y(e,t),f(e)}))};$((()=>{Shiny.addCustomMessageHandler("block-list-init",(t=>{setTimeout((()=>{u(t),e()}),t.delay)})),Shiny.addCustomMessageHandler("block-list-bind",(t=>{setTimeout((()=>{g(),e()}),t.delay)})),Shiny.addCustomMessageHandler("block-list-endpoints",(e=>{h(e),f(e)}))}))})();