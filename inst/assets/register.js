(()=>{"use strict";const e=()=>{let e;$(".add-block").off("mouseenter"),$(".add-block").off("mouseleave"),$(".add-block").on("mouseenter",(n=>{clearTimeout(e);const a=$(n.currentTarget);a.closest(".blockr-registry").find(".blockr-description").html(`<p class="p-0">\n        ${a.data("icon")||'<i class="fas fa-cube"></i>'}\n        <strong>${a.data("name")||""}</strong><br/>\n        <small>${a.data("description")||""}</small></p>`),t(a.closest(".blockr-registry").find(".blockr-description"))})),$(".add-block").on("mouseleave",(t=>{const a=$(t.currentTarget).closest(".blockr-registry").find(".blockr-description");clearTimeout(e),e=setTimeout((()=>{n(a),$(a).text("")}),250)}))},t=e=>{$(e).addClass("rounded border border-primary p-1 my-1")},n=e=>{$(e).removeClass("rounded border border-primary p-1 my-1")};var a;!function(e){e[e.noStack=1]="noStack",e[e.noBlockIndex=2]="noBlockIndex",e[e.stackAlreadyHasDataBlock=3]="stackAlreadyHasDataBlock",e[e.stackAlreadyHasPlotBlock=4]="stackAlreadyHasPlotBlock",e[e.noStackArea=5]="noStackArea"}(a||(a={}));const o=new Map;o.set(a.noStack,"must drag blocks within a stack"),o.set(a.noStackArea,"cannot place stack here"),o.set(a.noBlockIndex,"could not find block index"),o.set(a.stackAlreadyHasDataBlock,"this stack already includes a data block"),o.set(a.stackAlreadyHasPlotBlock,"this stack already includes a plot block");const s=new Map;var r;s.set(a.noStack,"no-stack"),s.set(a.noBlockIndex,"no-block-index"),s.set(a.stackAlreadyHasDataBlock,"stack-already-has-data-block"),s.set(a.stackAlreadyHasPlotBlock,"stack-already-has-plot-block"),function(e){e[e.deferred=1]="deferred",e[e.throttled=2]="throttled",e[e.immediate=3]="immediate"}(r||(r={}));const l=new Map;l.set(r.deferred,"deferred"),l.set(r.throttled,"throttle"),l.set(r.immediate,"event");const c=e=>{let t=e.id;e.ns&&(t=`${e.ns}-${t}`);const n=l.get(e.priority)||"deferred";Shiny.setInputValue(t,e.message,{priority:n})},d=e=>{const t=e.substring(0,4).normalize();return t[0].toUpperCase()+t.substring(1)+e.substring(4)};let i="",k=0,u="",p=!1;const g=e=>{const t=$(e).closest(".block"),n=t.data("value");let a=0;return t.closest(".stack").find(".block").each(((e,t)=>{$(t).data("value")==n&&(a=e+1)})),a},h=()=>{$(".stack").off("dragover dragenter drop dragdrop"),$(".stack").on("dragover",(e=>{e.preventDefault()})),$(".stack").on("dragenter",(e=>{e.preventDefault()})),$(".stack").on("drop dragdrop",(e=>{p=!0,k<0||(c({id:"dropped",ns:i,message:{type:u,index:k,position:g(e.target),target:$(e.target).closest(".stack").attr("id")},priority:r.immediate}),k=-1)}))},m=e=>{$(`#${e.id} .block-list-wrapper`).each(((t,n)=>{b(n,e)}))},b=(e,t)=>{h(),$(e).find(".add-block").each(((e,n)=>{$(n).hasClass("sorted")||($(n).addClass("sorted"),$(n).on("dragstart",(e=>{var t;u=$(e.target).data("type"),k=$(e.target).data("index"),i=(e=>{const t=null==e?void 0:e.split("-");return null==t?void 0:t.slice(0,t.length-1).join("-")})($(e.target).closest(".blockr-registry").attr("id")),e.originalEvent.dataTransfer.setData("text/plain",null===(t=e.target)||void 0===t?void 0:t.id)})),$(n).on("dragover",(e=>{p=!1,e.preventDefault()})),$(n).on("dragenter",(e=>{c({id:"started",ns:t.ns,message:{type:u,index:k},priority:r.immediate}),e.preventDefault()})),$(n).on("dragend",(()=>{p||(e=>{(e=>{if(!e.feedback)return;const t=$(`#${e.ns}-toast`);t.find(".toast-body").text(d(o.get(e.type))||"Unknown error"),t.show(),setTimeout((()=>{t.hide()}),4500)})(e);const t={ns:e.ns,id:"error",message:{type:s.get(e.type)||"unknown error",message:o.get(e.type)||"unknown error"},priority:r.immediate};c(t),console.error(`${t.message.message}`)})({id:"error",ns:t.ns,type:a.noStack,feedback:t.feedback})})))}))},f=(t,n)=>{const a=n.map((e=>{return`<p class="cursor-pointer mb-1 badge add-block bg-${y(t=e)} me-1"\n    data-index="${t.index}"\n    data-icon='${t.icon}'\n    data-name="${t.name}"\n    data-description="${t.description}"\n    draggable="true">\n    ${t.name}\n  </p>`;var t})).join("");$(`#${t.ns}-scrollable-child`).append(a),m(t),e(),A(t)},y=e=>e.classes.includes("data_block")?"primary":e.classes.includes("transform_block")?"secondary":"info";var v=function(e,t,n,a){return new(n||(n=Promise))((function(o,s){function r(e){try{c(a.next(e))}catch(e){s(e)}}function l(e){try{c(a.throw(e))}catch(e){s(e)}}function c(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(r,l)}c((a=a.apply(e,t||[])).next())}))};const x=e=>{$(`#${e.ns}-scrollable`).off("scroll")},w=e=>{S(e),x(e),$(`#${e.ns}-scrollable`).on("scroll",(t=>{$(`#${e.ns}-scrollable-child`).height()-$(`#${e.ns}-scrollable`).height()-$(t.target).scrollTop()>10||(x(e),function(e){return v(this,void 0,void 0,(function*(){const t=B(e.ns);return fetch(`${e.scroll}&min=${t+1}`).then((e=>e.json())).then((t=>{t.length&&f(e,t)}))}))}(e).then((()=>w(e))))}))};function S(e){return v(this,void 0,void 0,(function*(){const t=B(e.ns);return fetch(`${e.scroll}&min=${t+1}`).then((e=>e.json())).then((t=>{t.length&&(f(e,t),$(`#${e.ns}-scrollable-child`).height()<=$(`#${e.ns}-scrollable`).height()&&S(e))}))}))}const B=e=>$(`#${e}-scrollable`).find(".add-block").length,A=e=>{$(`#${e.ns}-search`).off("click"),$(`#${e.ns}-query`).off("keyup"),$(`#${e.ns}-search`).on("click",H(e)),$(`#${e.ns}-query`).on("keyup",H(e))},H=e=>t=>{if(t.key&&"Enter"!=t.key)return;const{target:n}=t,a=$(`#${e.ns}-query`),o=String(null==a?void 0:a.val());$(n).closest(".blockr-registry").find(".block-list-wrapper").html(""),""!=o?fetch(`${e.search}&query=${encodeURIComponent(o)}`).then((e=>e.json())).then((t=>{f(e,t),x(e)})):fetch(`${e.scroll}&min=1&max=10`).then((e=>e.json())).then((t=>{f(e,t),w(e)}))};$((()=>{Shiny.addCustomMessageHandler("block-list-init",(t=>{setTimeout((()=>{m(t),e()}),t.delay)})),Shiny.addCustomMessageHandler("block-list-bind",(t=>{setTimeout((()=>{h(),e()}),t.delay)})),Shiny.addCustomMessageHandler("block-list-endpoints",(e=>{setTimeout((()=>{A(e),w(e)}),e.delay)}))}))})();