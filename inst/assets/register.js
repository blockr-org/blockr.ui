(()=>{"use strict";const e=()=>{let e;$(".add-block").off("mouseenter"),$(".add-block").off("mouseleave"),$(".add-block").on("mouseenter",(a=>{clearTimeout(e);const n=$(a.currentTarget);n.closest(".blockr-registry").find(".blockr-description").html(`<small>${n.data("icon")||'<i class="fas fa-cube"></i>'}${n.data("description")}</small>`),t(n.closest(".blockr-registry").find(".blockr-description"))})),$(".add-block").on("mouseleave",(t=>{const n=$(t.currentTarget).closest(".blockr-registry").find(".blockr-description");clearTimeout(e),e=setTimeout((()=>{a(n),$(n).text("")}),250)}))},t=e=>{$(e).addClass("border border-primary p-2 my-1")},a=e=>{$(e).removeClass("border border-primary p-2 my-1")};var n;!function(e){e[e.noStack=1]="noStack",e[e.noBlockIndex=2]="noBlockIndex",e[e.stackAlreadyHasDataBlock=3]="stackAlreadyHasDataBlock",e[e.stackAlreadyHasPlotBlock=4]="stackAlreadyHasPlotBlock",e[e.noStackArea=5]="noStackArea"}(n||(n={}));const o=new Map;o.set(n.noStack,"must drag blocks within a stack"),o.set(n.noStackArea,"cannot place stack here"),o.set(n.noBlockIndex,"could not find block index"),o.set(n.stackAlreadyHasDataBlock,"this stack already includes a data block"),o.set(n.stackAlreadyHasPlotBlock,"this stack already includes a plot block");const s=new Map;var r;s.set(n.noStack,"no-stack"),s.set(n.noBlockIndex,"no-block-index"),s.set(n.stackAlreadyHasDataBlock,"stack-already-has-data-block"),s.set(n.stackAlreadyHasPlotBlock,"stack-already-has-plot-block"),function(e){e[e.deferred=1]="deferred",e[e.throttled=2]="throttled",e[e.immediate=3]="immediate"}(r||(r={}));const l=new Map;l.set(r.deferred,"deferred"),l.set(r.throttled,"throttle"),l.set(r.immediate,"event");const c=e=>{let t=e.id;e.ns&&(t=`${e.ns}-${t}`);const a=l.get(e.priority)||"deferred";Shiny.setInputValue(t,e.message,{priority:a})},d=e=>{const t=e.substring(0,4).normalize();return t[0].toUpperCase()+t.substring(1)+e.substring(4)};let i="",k=0,u="",p=!1;const g=e=>{const t=$(e).closest(".block"),a=t.data("value");let n=0;return t.closest(".stack").find(".block").each(((e,t)=>{$(t).data("value")==a&&(n=e+1)})),n},h=()=>{$(".stack").off("dragover dragenter drop dragdrop"),$(".stack").on("dragover",(e=>{e.preventDefault()})),$(".stack").on("dragenter",(e=>{e.preventDefault()})),$(".stack").on("drop dragdrop",(e=>{p=!0,k<0||(c({id:"dropped",ns:i,message:{type:u,index:k,position:g(e.target),target:$(e.target).closest(".stack").attr("id")},priority:r.immediate}),k=-1)}))},b=e=>{$(`#${e.id} .block-list-wrapper`).each(((t,a)=>{f(a,e)}))},f=(e,t)=>{h(),$(e).find(".add-block").each(((e,a)=>{$(a).hasClass("sorted")||($(a).addClass("sorted"),$(a).on("dragstart",(e=>{var t;u=$(e.target).data("type"),k=$(e.target).data("index"),i=(e=>{const t=null==e?void 0:e.split("-");return null==t?void 0:t.slice(0,t.length-1).join("-")})($(e.target).closest(".blockr-registry").attr("id")),e.originalEvent.dataTransfer.setData("text/plain",null===(t=e.target)||void 0===t?void 0:t.id)})),$(a).on("dragover",(e=>{p=!1,e.preventDefault()})),$(a).on("dragenter",(e=>{c({id:"started",ns:t.ns,message:{type:u,index:k},priority:r.immediate}),e.preventDefault()})),$(a).on("dragend",(()=>{p||(e=>{(e=>{if(!e.feedback)return;const t=$(`#${e.ns}-toast`);t.find(".toast-body").text(d(o.get(e.type))||"Unknown error"),t.show(),setTimeout((()=>{t.hide()}),4500)})(e);const t={ns:e.ns,id:"error",message:{type:s.get(e.type)||"unknown error",message:o.get(e.type)||"unknown error"},priority:r.immediate};c(t),console.error(`${t.message.message}`)})({id:"error",ns:t.ns,type:n.noStack,feedback:t.feedback})})))}))},m=(t,a)=>{const n=a.map((e=>{return`<p class="cursor-pointer mb-1 badge add-block bg-${y(t=e)} me-1"\n    data-index="${t.index}"\n    data-icon='${t.icon}'\n    data-name="${t.name}"\n    data-description="${t.description}"\n    draggable="true">\n    ${t.name}\n  </p>`;var t})).join("");$(`#${t.ns}-scrollable-child`).append(n),b(t),e(),B(t)},y=e=>e.classes.includes("data_block")?"primary":e.classes.includes("transform_block")?"secondary":"info";var v=function(e,t,a,n){return new(a||(a=Promise))((function(o,s){function r(e){try{c(n.next(e))}catch(e){s(e)}}function l(e){try{c(n.throw(e))}catch(e){s(e)}}function c(e){var t;e.done?o(e.value):(t=e.value,t instanceof a?t:new a((function(e){e(t)}))).then(r,l)}c((n=n.apply(e,t||[])).next())}))};const x=e=>{$(`#${e.ns}-scrollable`).off("scroll")},w=e=>{S(e),x(e),$(`#${e.ns}-scrollable`).on("scroll",(t=>{$(`#${e.ns}-scrollable-child`).height()-$(`#${e.ns}-scrollable`).height()-$(t.target).scrollTop()>10||function(e){v(this,void 0,void 0,(function*(){const t=$(`#${e.ns}-scrollable`).find(".add-block").length;return fetch(`${e.scroll}&min=${t}`).then((e=>e.json())).then((t=>{t.length&&m(e,t)}))}))}(e)}))};function S(e){return v(this,void 0,void 0,(function*(){const t=$(`#${e.ns}-scrollable`).find(".add-block").length;return fetch(`${e.scroll}&min=${t}`).then((e=>e.json())).then((t=>{t.length&&(m(e,t),$(`#${e.ns}-scrollable-child`).height()<=$(`#${e.ns}-scrollable`).height()&&S(e))}))}))}const B=e=>{$(`#${e.ns}-search`).off("click"),$(`#${e.ns}-query`).off("keyup"),$(`#${e.ns}-search`).on("click",A(e)),$(`#${e.ns}-query`).on("keyup",A(e))},A=e=>t=>{if(t.key&&"Enter"!=t.key)return;const{target:a}=t,n=$(`#${e.ns}-query`),o=String(null==n?void 0:n.val());$(a).closest(".blockr-registry").find(".block-list-wrapper").html(""),""!=o?fetch(`${e.search}&query=${encodeURIComponent(o)}`).then((e=>e.json())).then((t=>{m(e,t),x(e)})):fetch(`${e.scroll}&min=1&max=10`).then((e=>e.json())).then((t=>{m(e,t),w(e)}))};$((()=>{Shiny.addCustomMessageHandler("block-list-init",(t=>{setTimeout((()=>{b(t),e()}),t.delay)})),Shiny.addCustomMessageHandler("block-list-bind",(t=>{setTimeout((()=>{h(),e()}),t.delay)})),Shiny.addCustomMessageHandler("block-list-endpoints",(e=>{setTimeout((()=>{B(e),w(e)}),e.delay)}))}))})();